<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <script src="https://unpkg.com/panzoom@7.1.2/dist/panzoom.min.js"></script>
    <script src="./other/js/js-yaml.js"></script>
    <script src="./other/js/map_pos.js"></script>
    <link rel="stylesheet" type="text/css" href="./main.css" />
  </head>

  <body>
    <div id="rootDiv" style="width:100%;height:80%;background-color:green">
      <svg width="100%" height="100%">
        <g id="board" viewBox="0 0 3400 2200">
          <image width="3400" height="2200" xlink:href="./other/assets/TTmap.jpg" />
        </g>
      </svg>
      <div id="mypopup">
        <h1 style="text-align:center">Popup title</h1>
        <h4 style="text-align:center">Axis Protectorate</h4>
        <p>Caders Axis West UDSSR table</p>
      </div>
    </div>
    <div id="testDiv" style="width:100%;height:20%;background-color:green">
      <button onclick="reset()">reset</button>

      so cool!!!!!!!!!
    </div>
    <div id="troopDisplay" style="position:absolute;left:0%;bottom:0%"></div>

    <!-- #region globals -->
    <script>
      const rootDiv = document.getElementById("rootDiv");
      const board = document.getElementById("board");
      const mapPosDict = jsyaml.load(mapPosStr);
    </script>
    <!-- #endregion -->

    <!-- #region panzoom -->
    <script>
      var pz = undefined;
      function reset() {
        // get actualwidth of rootDiv
        let width = rootDiv.offsetWidth;
        let height = rootDiv.offsetHeight;

        // scale board so that the width fits exactly
        let scaleFactor = width / 3400;

        board.setAttribute("transform", `translate(0,0) scale(${scaleFactor})`);
        if (pz != undefined) {
          pz.dispose();
          pz = undefined;
        }
        //TODO: make sure dispose is not async!!!!
        pz = panzoom(board, {
          zoomDoubleClickSpeed: 1,
          zoomSpeed: 0.1, // 0.065, // 6.5% per mouse wheel event
          maxZoom: 2,
          minZoom: 0.1
        });
      }
      reset();
    </script>
    <!-- #endregion -->

    <!-- #region regions added to map, tooltips -->
    <script>
      const POPUP_WIDTH = 200;
      const POPUP_HEIGHT = 250;
      var wpopup = POPUP_WIDTH; //estimation at start
      var hpopup = POPUP_HEIGHT; //estimation at start
      function showPopup(ev) {
        let mypopup = document.getElementById("mypopup");
        let reg = ev.target;

        // calc popup content
        let title = mypopup.getElementsByTagName("h1")[0];
        title.innerHTML = reg.id;
        let status = mypopup.getElementsByTagName("h4")[0];
        status.innerHTML = "Axis Protectorate";
        let content = mypopup.getElementsByTagName("p")[0];
        content.innerHTML = `
          <table>
            <tr>
              <th>cader</th>
              <th>Axis</th>
              <th>West</th>
              <th>UDSSR</th>
            </tr>
            <tr>
              <td>infantry</td>
              <td>1 1 1</td>
              <td>2 4</td>
              <td>4</td>
            </tr>
            <tr>
              <td>infantry</td>
              <td>1 1 1</td>
              <td>2 2 2 2 2</td>
              <td></td>
            </tr>
            <tr>
              <td>infantry</td>
              <td>1 1 1</td>
              <td></td>
              <td>1 1 3 4</td>
            </tr>
            <tr>
              <td>infantry</td>
              <td>1 1 1</td>
              <td>3 3</td>
              <td></td>
            </tr>
            <tr>
              <td>infantry</td>
              <td>1 1 1</td>
              <td></td>
              <td></td>
            </tr>
            <tr>
              <td>infantry</td>
              <td></td>
              <td>1 1 1</td>
              <td></td>
            </tr>
            <tr>
              <td>infantry</td>
              <td></td>
              <td></td>
              <td>1 1 1</td>
            </tr>
            <tr>
              <td>infantry</td>
              <td>1 1 1</td>
              <td></td>
              <td></td>
            </tr>
          </table>
          `;

        // calc position of tooltip
        // get mouse position
        let mx = ev.clientX;
        let my = ev.clientY;
        // get actual width and height of rootDiv
        let width = rootDiv.offsetWidth;
        let height = rootDiv.offsetHeight;

        //console.log("popup ", mx, my, width, height, wpopup, hpopup);

        let isLeft = mx < width / 2; //width-mx > POPUP_WIDTH;
        let isTop = my > height / 2; //my > POPUP_HEIGHT;

        var iconPos = reg.getBoundingClientRect();
        // mypopup.style.left = isLeft?iconPos.right + "px":iconPos.left - POPUP_WIDTH/2 +"px";
        mypopup.style.left = isLeft ? iconPos.right + "px" : iconPos.left - wpopup + "px";

        // top should be center of boundingrect height
        mypopup.style.top = isTop ? iconPos.top - hpopup / 2 + "px" : iconPos.top + "px";

        //mypopup.style.top = isBottom?window.scrollY + iconPos.top - 60 + "px":iconPos.top - POPUP_HEIGHT +"px";
        //mypopup.style.top = window.scrollY + iconPos.top - 60 + "px";
        mypopup.style.display = "block";
      }
      function hidePopup(evt) {
        var mypopup = document.getElementById("mypopup");
        wpopup = mypopup.offsetWidth;
        hpopup = mypopup.offsetHeight;
        //console.log("popup width for real: ", wpopup, hpopup);
        mypopup.style.display = "none";
      }
      function addRegion(svgEl, x, y) {
        let circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        circle.setAttribute("cx", x);
        circle.setAttribute("cy", y);
        circle.setAttribute("r", "100");
        circle.setAttribute("class", "region");
        svgEl.appendChild(circle);
        return circle;
      }
      for (k of Object.keys(mapPosDict)) {
        let p = mapPosDict[k];
        let region = addRegion(board, p.x, p.y);
        region.id = k;
        region.addEventListener("mouseover", showPopup);
        region.addEventListener("mouseout", hidePopup);
        region.addEventListener("click", ev => console.log("clicked on " + ev.target.id));
      }
    </script>
    <!-- #endregion regions added to map -->

    <!-- #region functionality to add troops to a region -->
    <script>
      const troopColors = {
        Germany: [174, 174, 176],
        Britain: [86, 182, 222],
        France: [121, 200, 205],
        USSR: [233, 138, 134],
        USA: [145, 186, 130],
        Italy: [164, 162, 141],
        Neutral: [255, 255, 102]
      };

      var troopCounter = 0; //not used

      const troopInfo = {
        infantry: ["infantry", "|", 2],
        tank: ["tank", "3", 1],
        air: ["airforce", "x", 2],
        sub: ["submarine", "m", 1],
        fleet: ["fleet", "p", 1],
        convoy: ["convoy", "e", 1],
        carrier: ["carrier", "o", 1],
        fort: ["fort", ",", 2] //oder '0'
      };

      function createCader(type = "fort", origin = "Britain", sz = 100) {
        // get type symbol
        let info = troopInfo[type];
        let letter = info[1];
        let scaleFactor = info[2];
        let name = info[0];

        // calculate color
        let rgb = troopColors[origin];
        let color = `rgba(${rgb[0]},${rgb[1]},${rgb[2]},1)`;

        // calculate value (1)
        let val = 1;

        // create svg element
        const svg1 = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg1.setAttribute("width", sz);
        svg1.setAttribute("height", sz);

        // create symbol
        // <text x="13%" y="80%" fill="rgba(255,255,255,.3)" class="milgiant">0</text>
        const txtSymbol = document.createElementNS("http://www.w3.org/2000/svg", "text");
        const fs = {
          infantry: {fz: 0.5, x: 0.5, y: 5 / 6},
          fleet: {fz: 0.35, x: 0.45, y: 4 / 5.2},
          convoy: {fz: 0.35, x: 0.5, y: 5 / 6},
          tank: {fz: 0.25, x: 0.5, y: 5 / 6.4},
          air: {fz: 0.6, x: 0.5, y: 5.2 / 6},
          carrier: {fz: 0.25, x: 0.5, y: 5 / 6.4},
          sub: {fz: 0.25, x: 0.5, y: 5 / 6.4},
          fort: {fz: 0.6, x: 0.5, y: 5.2 / 6}
        };
        let f = fs[type];
        txtSymbol.setAttribute("font-family", "Military RPG");
        txtSymbol.setAttribute("font-size", "" + sz * f.fz + "px"); //(scaleFactor*1.5)+"rem");
        txtSymbol.setAttribute("x", sz * f.x);
        txtSymbol.setAttribute("y", sz * f.y);
        txtSymbol.setAttribute("text-anchor", "middle");
        txtSymbol.textContent = letter;
        txtSymbol.setAttribute("fill", "rgba(255,255,255,.3)");

        // create value
        // <text x="35%" y="66%" fill="white" font-size="40px">1</text>
        const txtVal = document.createElementNS("http://www.w3.org/2000/svg", "text");
        txtVal.setAttribute("font-size", "" + sz / 2 + "px");
        txtVal.setAttribute("x", sz / 2);
        txtVal.setAttribute("y", "70%");
        txtVal.setAttribute("text-anchor", "middle");
        txtVal.textContent = val;
        txtVal.setAttribute("fill", "red");

        // create name
        // <text x="40" y="10%" text-anchor="middle" fill="orange" font-size="12px">fort</text>
        const txtName = document.createElementNS("http://www.w3.org/2000/svg", "text");
        txtName.setAttribute("font-size", "" + sz / 6 + "px");
        txtName.setAttribute("x", sz / 2);
        txtName.setAttribute("y", "28%");
        txtName.setAttribute("text-anchor", "middle");
        txtName.textContent = name;
        txtName.setAttribute("fill", "orange");

        // create a shape
        // <rect x="15%" y="15%" width="70%" height="70%" style="fill:rgba(0,0,0,.5);stroke-width:1;stroke:rgb(0,0,0)" />
        const outerRect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        outerRect.setAttribute("x", "0%");
        outerRect.setAttribute("y", "0%");
        outerRect.setAttribute("rx", "10%");
        outerRect.setAttribute("ry", "10%");
        outerRect.setAttribute("width", "100%");
        outerRect.setAttribute("height", "100%");
        outerRect.style = `fill:${color};stroke-width:1;stroke:rgb(0,0,0)`;

        const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        let percentage = 6.25;
        rect.setAttribute("x", percentage + "%");
        rect.setAttribute("y", percentage + "%");
        rect.setAttribute("rx", "5%");
        rect.setAttribute("ry", "5%");
        rect.setAttribute("width", 100 - 2 * percentage + "%");
        rect.setAttribute("height", 100 - 2 * percentage + "%");
        rect.style = "fill:rgba(0,0,0,.5);stroke-width:1;stroke:rgb(0,0,0)";

        // create a shape
        const cir1 = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        cir1.setAttribute("cx", sz / 2);
        cir1.setAttribute("cy", sz / 2);
        cir1.setAttribute("r", sz / 2);
        cir1.setAttribute("fill", color);

        // attach the shape to svg
        //svg1.appendChild(cir1);
        svg1.appendChild(outerRect);
        svg1.appendChild(rect);
        svg1.appendChild(txtName);
        svg1.appendChild(txtSymbol);
        svg1.appendChild(txtVal);

        return svg1;
      }
      function placeCader(type = "fort", origin = "Britain", region = "Iceland") {
        // calculate position
        let pos = mapPosDict[region];

        // create cader and set position
        let sz = 200;
        let svg1 = createCader(type, origin, sz);
        svg1.setAttribute("x", pos.x - sz / 2);
        svg1.setAttribute("y", pos.y - sz / 2);

        board.appendChild(svg1);
      }
      //placeCader(); //test
    </script>
    <!-- #endregion functionality to add troops to a region -->

    <!-- #region cader display just for fun -->
    <script>
      const dd = document.getElementById("troopDisplay");
      function displayCaders() {
        let sz = 100;
        dd.appendChild(createCader("infantry", "Italy", sz));
        dd.appendChild(createCader("fort", "France", sz));
        dd.appendChild(createCader("air", "USSR", sz));
        dd.appendChild(createCader("convoy", "USA", sz));
        dd.appendChild(createCader("tank", "Germany", sz));
        dd.appendChild(createCader("fleet", "Britain", sz));
        dd.appendChild(createCader("fort", "Neutral", sz));
        dd.appendChild(createCader("carrier", "USA", sz));
        // Germany: [174, 174, 176],
        // Britain: [86, 182, 222],
        // France: [121, 200, 205],
        // USSR: [233, 138, 134],
        // USA: [145, 186, 130],
        // Italy: [164, 162, 141],
        // Neutral: [255, 255, 102]
        // infantry: ["infantry", "|", 2],
        // tank: ["tank", "3", 1],
        // air: ["airforce", "x", 2],
        // sub: ["submarine", "m", 1],
        // fleet: ["fleet", "p", 1],
        // convoy: ["convoy", "e", 1],
        // carrier: ["carrier", "o", 1],
        // fort: ["fort", ",", 2] //oder '0'
      }
      displayCaders();
    </script>
  </body>
</html>
